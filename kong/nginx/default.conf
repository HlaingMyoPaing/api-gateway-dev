  # /etc/nginx/conf.d/default.conf
  proxy_http_version 1.1;
  proxy_buffering off;
  proxy_redirect off;
  absolute_redirect off;

  map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
  }

  upstream gui_upstream {
  server kong:8002; # or your GUI container:port
  }

  upstream admin_api_upstream {
  server kong:8001; # Kong Admin API (internal)
  }

  server {
    listen 80;
    server_name _;

    # Normalize /admin -> /admin/
    location = /admin { return 301 /admin/; }

    # Serve our override kconfig.js (no proxy)
   # location = /admin/kconfig.js {
   #    root /etc/nginx/static; # we will mount the file here
   #    add_header Cache-Control "no-store" always;
   #    try_files /admin/kconfig.js =404;
   # }

    # Main admin GUI route
    location /admin/ {
      # strip the /admin prefix before proxying
      rewrite ^/admin/(.*)$ /admin/$1 break;

      proxy_pass http://gui_upstream; # no /admin here
      proxy_redirect ~^/admin/(.*)$ /admin/$1;
      proxy_cookie_path / /admin;

      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_intercept_errors on;
     error_page 404 = @spa;
    }

    # Static asset caching
    location ~* ^/admin/.*\.(?:js|mjs|css|map|png|jpg|jpeg|gif|svg|ico|woff2?|ttf)$ {
      proxy_pass http://gui_upstream;
      expires 7d;
      add_header Cache-Control "public, max-age=604800";
    }

    # SPA fallback for Vue/React-style routing
    location @spa {
       proxy_pass http://gui_upstream;
    }

    # If you serve the SPA from disk instead, use this instead of the /admin/ block above:
    # location /admin/ {
    # root /usr/share/nginx/html;
    # try_files $uri $uri/ /admin/index.html;
    # }

    # Static assets (cacheable) — works for both proxy or disk variants
    location ~* ^/admin/.*\.(?:js|mjs|css|map|png|jpg|jpeg|gif|svg|ico|woff2?|ttf)$ {
    # If you used the proxy variant above:
       rewrite ^/admin/(.*)$ /$1 break;
       proxy_pass http://gui_upstream;
       expires 7d;
       add_header Cache-Control "public, max-age=604800";
    }


  # --- Admin API (same-origin path) ---
    location /admin-api {

      # Preflight (many GUIs issue OPTIONS even when same-origin)
      if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Accept, Authorization, Content-Type, Kong-Admin-Token" always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
      return 204;
    }

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # WebSocket upgrade (if any)
      #proxy_set_header Upgrade $http_upgrade;
      #proxy_set_header Connection $connection_upgrade;

      # Strip the /admin-api/ prefix when forwarding
      rewrite ^/admin-api/?(.*)$ /$1 break;
      proxy_pass http://admin_api_upstream/; # <— trailing slash
    }


  }